<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js navy">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>System Design of URL Shourtener Service - my read books</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../books.html"><strong aria-hidden="true">1.</strong> Books</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../books/google-software-engineering.html"><strong aria-hidden="true">1.1.</strong> Google Software Engineering</a></li><li class="chapter-item expanded "><a href="../books/clean-architecture.html"><strong aria-hidden="true">1.2.</strong> Clean Architecture</a></li></ol></li><li class="chapter-item expanded "><a href="../system-design-interview.html"><strong aria-hidden="true">2.</strong> System Design Interview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../system-design-interview/introduction.html"><strong aria-hidden="true">2.1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../system-design-interview/ip-osimodel.html"><strong aria-hidden="true">2.2.</strong> IP DNS and TCP/UDP</a></li><li class="chapter-item expanded "><a href="../system-design-interview/loadblancer-clustering.html"><strong aria-hidden="true">2.3.</strong> Load Balancing and Clustering</a></li><li class="chapter-item expanded "><a href="../system-design-interview/cache-cdn.html"><strong aria-hidden="true">2.4.</strong> Cache and CDN</a></li><li class="chapter-item expanded "><a href="../system-design-interview/databases.html"><strong aria-hidden="true">2.5.</strong> Databases</a></li><li class="chapter-item expanded "><a href="../system-design-interview/url-shortener-service.html" class="active"><strong aria-hidden="true">2.6.</strong> System Design of URL Shourtener Service</a></li></ol></li><li class="chapter-item expanded "><a href="../videos.html"><strong aria-hidden="true">3.</strong> Videos</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../videos/how-greate-leaders-inspire-action.html"><strong aria-hidden="true">3.1.</strong> How greate leaders inspire action?</a></li></ol></li><li class="chapter-item expanded "><a href="../dev-tips.html"><strong aria-hidden="true">4.</strong> Dev-tips</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dev-tips/git-communications.html"><strong aria-hidden="true">4.1.</strong> Git Commuincations</a></li><li class="chapter-item expanded "><a href="../dev-tips/mercari-ladders.html"><strong aria-hidden="true">4.2.</strong> Mercari Engeneer Ladders</a></li></ol></li><li class="chapter-item expanded "><a href="../health.html"><strong aria-hidden="true">5.</strong> Health</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../health/training.html"><strong aria-hidden="true">5.1.</strong> training</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">my read books</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="system-design-of-scaleble-url-shortener-service"><a class="header" href="#system-design-of-scaleble-url-shortener-service">System Design of Scaleble URL shortener service</a></h1>
<p>source: https://medium.com/@sandeep4.verma/system-design-scalable-url-shortener-service-like-tinyurl-106f30f23a82</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<ul>
<li>URLの保持期間は？</li>
<li>URLの長さはどれくらい？</li>
<li>ユーザーがURLを作成できるようにするか、サービス側で自動生成するか。</li>
<li>生成したURLに対してどれくらいのトラフィックが生じるか？</li>
<li>どのようなメトリクスを計測するべきか。</li>
</ul>
<h2 id="system-design-goals"><a class="header" href="#system-design-goals">System Design Goals</a></h2>
<h3 id="機能要件"><a class="header" href="#機能要件">機能要件</a></h3>
<ul>
<li>長いURLを短いURLに変換することができる。</li>
<li>短縮URLをクリックするとオリジナルのURLにリダイレクトされる。</li>
<li>短縮URLの長さは可能な限り短くする。</li>
<li>ユーザーは最大16文字を使ってカスタムの短縮URLを作成可能。</li>
<li>最もクリックされたリンクなどのメトリクスを計測している。</li>
<li>作成された短縮URLは一定期間、システムが保持する必要がある。</li>
</ul>
<h3 id="非機能要件"><a class="header" href="#非機能要件">非機能要件</a></h3>
<ul>
<li>サービスは常に稼働する必要がある。</li>
<li>URLリダイレクトは常に高速であること（負荷のピークであっても）</li>
<li>サードパーティとの統合のために、APIエンドポイントを公開できる。</li>
</ul>
<h2 id="traffic-and-system-capacity"><a class="header" href="#traffic-and-system-capacity">Traffic and System Capacity</a></h2>
<h3 id="traffic"><a class="header" href="#traffic">Traffic</a></h3>
<ul>
<li>200:1 = read/write ratio</li>
<li>1月のユニークな短縮URLの数 = 100M</li>
<li>1秒当たりの生成される短縮URLの数 ~ 40 URLs/second (30 days * 24 hours * 3600 seconds)</li>
<li>1秒当たりのリダイレクト数 = 40 URLs/s * 200 (read/write ratio) = 8000 URLs/s</li>
</ul>
<h3 id="storage"><a class="header" href="#storage">Storage</a></h3>
<ul>
<li>サービスのライフタイム = 100y (100M urls per month)</li>
<li>ライフタイム分のURL数 = 100 * 12 * 100M = 120B</li>
<li>URL、作成日付などのデータオブジェクトを500byteとすると必要なストレージは 120B * 500 bytes = 60TB</li>
</ul>
<h3 id="memory"><a class="header" href="#memory">Memory</a></h3>
<ul>
<li>Pareto Principle (20:80 lows)に基づいて、20%のデータをキャッシュすることで80%のリクエストをカバーできると仮定する。</li>
<li>8000 read request/seconds * 86400 seconds = 700M read request per day)</li>
<li>キャッシュするデータ量は 700M * 0.2 * 500 bytes ~ 70GB</li>
</ul>
<pre><code class="language-text">Shortened URLs generated: 40/s
Shortened URLs generated in 100 years: 120 billion
Total URL requests/redirections: 8000/s
Storage for 100 years: 60TB
Cache Memory: 70 GB
</code></pre>
<h2 id="high-level-design"><a class="header" href="#high-level-design">High Level Design</a></h2>
<pre class="mermaid">flowchart LR
    LR((client)) --&gt; WebServer
    WebServer --&gt; LR((client))
    Analytics --&gt; WebServer
    DB[(Database)] --&gt; WebServer
    WebServer --&gt; DB[(Database)]
</pre>
<h3 id="problems-with-above-design"><a class="header" href="#problems-with-above-design">Problems with above design</a></h3>
<ul>
<li>サーバーが一つしかないため、単一障害点（SPOF）となる。</li>
<li>システムがスケールできない。</li>
<li>60TBは一つのDBでは賄いきれない。また、8000/sのリードリクエストを処理できない。</li>
</ul>
<h3 id="to-cater-above-limitations"><a class="header" href="#to-cater-above-limitations">To cater above limitations</a></h3>
<ul>
<li>ロードバランサーを追加する。</li>
<li>データベースをシャードして、巨大なデータを格納できるようにする。</li>
<li>キャッシュを追加して、DBへの負荷を減らす。</li>
</ul>
<pre class="mermaid">flowchart LR
    subgraph webserver
        WebServer2
        WebServer
    end
    LR((client)) --&gt; LoadBalancer
    LoadBalancer --&gt; WebServer
    LoadBalancer --&gt; WebServer2
    DB[(Database)] --&gt; WebServer
    WebServer --&gt; DB[(Database)]
    DB[(Database)] --&gt; WebServer2
    WebServer2 --&gt; DB[(Database)]
    Cache --&gt; WebServer
    Cache --&gt; WebServer2
</pre>
<h2 id="algorithms-rest-endpoints"><a class="header" href="#algorithms-rest-endpoints">Algorithms REST Endpoints</a></h2>
<pre><code class="language-text">create(long_url, api_key, custom_url)

POST
Request Body: `{url=long_url, custom_url (optional)}`
Return OK (200) with the generated `short_url` in data
</code></pre>
<pre><code class="language-text">get(short_url)
Return a http redirect response (302)
</code></pre>
<p><strong>Tips</strong></p>
<p>A 301 redirect means the page has permanently moved to a new location.
A 302 redirect means that the moves is only temporaly. &lt;- こうすると、クライアントからのリダイレクトリクエストがバックエンドまで飛んでくるためメトリクスの計測が可能。</p>
<h2 id="database-schema"><a class="header" href="#database-schema">Database Schema</a></h2>
<p><strong>User table</strong></p>
<pre><code class="language-text">user_id: unique
name:
email:
creation_date
</code></pre>
<p><strong>URL table</strong></p>
<pre><code class="language-text">short_url:
original_url:
user_id:
</code></pre>
<h2 id="shortening-algorithm"><a class="header" href="#shortening-algorithm">Shortening Algorithm</a></h2>
<p>Candidates are as follows:</p>
<ul>
<li>URL Encoding</li>
<li>URL Encoding with base62</li>
<li>URL Encoding through md5</li>
<li>Key generation service (KGS)</li>
</ul>
<p>base64でエンコードする場合、<code>[0-9][a-z][A-Z]</code>、すなわち一文字当たり64通りで変換される。
7文字使えば、<code>64^7 ~ 3500B</code>になるため要件の120Bを満たす。
従って、７文字のbase64エンコーディングすれば良いことがわかる。</p>
<p>次に、このアルゴリズムを使ってどのようにユニークなエンコード結果を得るか考える。</p>
<h3 id="method1-random"><a class="header" href="#method1-random">Method1: Random</a></h3>
<p>最も単純な方法は、ランダムに生成してそれがDBになければ保存、既存の場合は再度生成を繰り返す方法。</p>
<h3 id="method2-base-conversion"><a class="header" href="#method2-base-conversion">Method2: Base Conversion</a></h3>
<p>もっと良い方法として、進数を変換させることでユニークはエンコード結果を得る方法がある。
具体的には、まずある十分に大きい10進数（64進数に変換した際に７桁あるもの）を用意する。
新しいURLが作成される度に、その10進数に1を加算した値を64進数に変換した結果をShort URLとする。
このようにしていけば、必ずユニークなショートURLが生成可能となる。</p>
<h3 id="method3-md5-hash"><a class="header" href="#method3-md5-hash">Method3: MD5 hash</a></h3>
<p>URL文字列をMDハッシュに変換し、変換結果の先頭７文字を用いる。
その7文字がすでに使用されている場合には次の7文字を用いる。
この操作を繰り返す。</p>
<h3 id="method4-key-generation-service-kgs"><a class="header" href="#method4-key-generation-service-kgs">Method4: Key Generation Service (KGS)</a></h3>
<p>シンプルに7文字の文字列（未使用）を生成し、保存しておく。
このようにすることで構造はずっとシンプルにすることが可能。</p>
<p>使用ずみ文字列テーブルと未使用のテーブルの2つを用意しておく。
また、常にメモリー状に未使用の文字列を持っておくことで高速なレスポンスを期待する。
さらに、使用と同時に最速で使用済みテーブルに格納されるために、同時接続があった場合にも対応できると考えられる。</p>
<p>単一障害点になりうるため常にレプリカを稼働させておく必要がある。</p>
<h2 id="databases"><a class="header" href="#databases">Databases</a></h2>
<ul>
<li>Relational databases</li>
<li>NoSQL-style databases like BigTable and Cassandra</li>
</ul>
<p>今回は、短縮URLが存在しない場合DBに格納することと、短縮URLがユニークである必要があるのでNoSQLライクなDBは不敵であると言える。</p>
<h3 id="scaling"><a class="header" href="#scaling">Scaling</a></h3>
<p>シャード技術を用いてスケーリングさせる。短縮URLのアルゴリズムごとにシャーディング戦略を立てることができる。</p>
<h4 id="for-method1-random"><a class="header" href="#for-method1-random">For method1: Random</a></h4>
<p>短縮URLの7文字ハッシュをシャーディングキーに代用可能（ユニークなキーを元によしなにシャーディングをしてくれるMongoDBなどがあるっぽい）。
また、短縮URLをインデックスすることでより高速な読み取りを期待できる。</p>
<h4 id="for-method2-base-conversion"><a class="header" href="#for-method2-base-conversion">For method2: Base Conversion</a></h4>
<p>新しい短縮URLごとに増えていく数字を使って、シャーディングができる。範囲指定する感じで。</p>
<h2 id="cache"><a class="header" href="#cache">Cache</a></h2>
<p>頻繁にアクセスされるURLはキャッシュしておく。</p>
<p>キャッシュに必要なデータ量は20％のリクエスト分のデータ。</p>
<p>キャッシュのポリシーはLeast Reacently Used（最も長い間参照されていないものから削除していく方法）が適している。</p>
<h2 id="load-balancer"><a class="header" href="#load-balancer">Load Balancer</a></h2>
<ul>
<li>クライアントとWebserverの間</li>
<li>WebServerとDBサーバーの間</li>
<li>WebServerとキャッシュサーバーの間</li>
</ul>
<p>ロードバランスの方法もいくつかあるみたい。</p>
<h2 id="customer-provided-tiny-urls"><a class="header" href="#customer-provided-tiny-urls">Customer provided Tiny URLs</a></h2>
<p>8文字以上も英数字と一部の特殊文字で生成してもらうようにすればOK。</p>
<h2 id="analytics"><a class="header" href="#analytics">Analytics</a></h2>
<p>302レスポンスを返すので、バックエンドサーバーにリクエストが飛ぶ。これをKafkaなどに送信すればOKなんだね。</p>
<h2 id="自分の考え"><a class="header" href="#自分の考え">自分の考え</a></h2>
<h3 id="システムが設計すべき事項解決すべき問題設計スコープ"><a class="header" href="#システムが設計すべき事項解決すべき問題設計スコープ">システムが設計すべき事項・解決すべき問題・設計スコープ</a></h3>
<p>要件</p>
<ul>
<li>与えられたURLに対し、自分のドメインのURLを生成して割り当てる。</li>
<li>すでに割り当て済みのURLがあった場合には、生成済みのURLを返す。</li>
<li>生成したURLにアクセスがあった場合に、登録された元のURLに対してリダイレクトする。</li>
<li>一定期間アクセスがなかったURLは自動で削除する。</li>
</ul>
<h3 id="hld"><a class="header" href="#hld">HLD</a></h3>
<pre class="mermaid">flowchart TD
    db --&gt; apiServer
    batchServer --&gt; db
    cacheServer --&gt; apiServer
</pre>
<h3 id="細部"><a class="header" href="#細部">細部</a></h3>
<h4 id="scaling-1"><a class="header" href="#scaling-1">Scaling</a></h4>
<ul>
<li>ユーザー数・CPU使用割合に応じたAPIサーバーのスケーリング。</li>
<li>データベースの量はそこまでいらない。ユーザー当たり、頻繁に短いURLを作成するケースは少ないと想定できるため。</li>
</ul>
<h4 id="cacheing"><a class="header" href="#cacheing">Cacheing</a></h4>
<ul>
<li>直近アクセスがあったURLはキャッシュしておく。</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../system-design-interview/databases.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../videos.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../system-design-interview/databases.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../videos.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../mermaid.min.js"></script>
        <script type="text/javascript" src="../mermaid-init.js"></script>
    </body>
</html>
